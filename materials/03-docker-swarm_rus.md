# Docker swarm


**Docker swarm** - инструмент оркестрации идущий в комплекте с *docker*. Оркестрация - это процесс управления различными контейнерами, распределенными между несколькими узлами в одном кластере. Оркестрация позволяет добиться:


- автоматической балансировки контейнеров между узлами;
- более высокой масштабируемости системы (подключение новых узлов и перераспределение нагрузки);
- рестарта "падающих" модулей развернутого ПО или *disaster recovery*, иными словами - инструмент оркестрации поддерживает высокую *доступность* системы;
- защищенности трафика между различными узлами внутри кластера;
- и самое главное - объединяет всю сложную структуру приложения с микросервисной архитектурой в некоторую единую сущность, имеющую одну точку входа, инкапсулируя в себе всю сложность и взаимодействуя с пользователем в той же манере, что и монолит.


Работать с docker swarm очень просто. Достаточно разбить узлы на две группы: менеджеры и рабочие узлы или *воркеры(workers)* и выполнить несколько команд.


Менеджеры - это узлы, которые осуществляют распределение задач (tasks) по узлам-воркерам и гарантируют непротиворечивое (консистентное) состояние их выполнения. Сами задачи отвечают некоторым сервисам - наборам реплик некоторого docker-образа. Реплик одного docker-образа может быть и больше одного. Одна задача соответствует одной реплике. Таким образом, менеджеры распределяют по воркерам задачи в размере суммы реплик всех запущенных сервисов, стараясь сбалансировать их по рабочей нагрузке. Когда отдается конкретному воркеру на выполнение, в нем стартует соответствующий образу сервиса контейнер.


Когда узлы объединены в один сварм, взаимодействие между их docker-engine'ами происходит по специальной оверлейной сети, что и позволяет осуществлять корректную оркестрацию. Драйвер оверлейной сети создает распределенную сеть между docker-engine'ами. Эта сеть как бы перекрывает (overlay) сети, специфичные для хоста, позволяя контейнерам, подключенным к ней (включая контейнеры службы swarm), безопасно обмениваться данными при включенном шифровании. Docker прозрачно обрабатывает маршрутизацию каждого пакета от и к каждому конкретному хосту docker-engine'а и каждому конкретному контейнеру.


Для того, чтобы актуализировать узел как менеджер, требуется выполнить команду `docker swarm init --advertise-addr [ip адрес машины для передачи в оверлейную сеть]`. После этого будет сгенерирован токен подключения для воркеров этого менеджера. Его можно сохранить используя команду `docker swarm join-token`.


Чтобы подключить воркер к менеджеру нужно использовать команду: `docker swarm join --token [токен] [ip адресс менеджера]`.


Для того, чтобы выполнить развертывание сразу всех сервисов приложения, можно использовать compose-файл и команду: `docker stack deploy`. Однако, так как задача по каждому сервису может в итоге быть делегирована любому воркеру, то образы должны быть "достижимы" из любого узла. То есть все образы необходимо загрузить в некоторый доступный из узлов docker registry (например, на личный registry в docker hub), после чего все образы сервисов в compose-файле должны быть заменены на загруженные в выбранный docker registry.

